<div class="page-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <div class="page-header">
    <h1>Teammitglieder verwalten</h1>
    <p>Erstellen, bearbeiten und verwalten Sie Teammitglieder</p>
  </div>

  <p-toolbar styleClass="mb-4">
    <ng-template #start>
      <p-button 
        label="Neues Mitglied" 
        icon="pi pi-plus" 
        severity="primary" 
        (onClick)="openNewDialog()"
        [disabled]="!isConnected">
      </p-button>
    </ng-template>
    <ng-template #end>
      <p-iconfield>
        <p-inputicon styleClass="pi pi-search" />
        <input 
          pInputText 
          type="text" 
          [(ngModel)]="globalFilter" 
          (input)="onGlobalFilter($event)" 
          placeholder="Suche..." />
      </p-iconfield>
    </ng-template>
  </p-toolbar>

  <div class="card" *ngIf="!isConnected">
    <p class="text-center text-secondary">
      <i class="pi pi-info-circle"></i>
      Bitte verbinden Sie zuerst ein Datenverzeichnis über die Einstellungen.
    </p>
  </div>

  <p-table 
    #dt
    *ngIf="isConnected"
    [value]="members" 
    [paginator]="true" 
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [globalFilterFields]="['displayName', 'email', 'tagsString']"
    [sortField]="'displayName'"
    [sortOrder]="1"
    styleClass="p-datatable-striped"
    [tableStyle]="{'min-width': '50rem'}">
    
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="displayName" style="min-width:12rem">
          Name <p-sortIcon field="displayName"></p-sortIcon>
        </th>
        <th pSortableColumn="email" style="min-width:14rem">
          E-Mail <p-sortIcon field="email"></p-sortIcon>
        </th>
        <th style="min-width:10rem">Tags</th>
        <th pSortableColumn="active" style="min-width:6rem">
          Status <p-sortIcon field="active"></p-sortIcon>
        </th>
        <th style="min-width:6rem">Themen</th>
        <th pSortableColumn="updatedAt" style="min-width:10rem">
          Aktualisiert <p-sortIcon field="updatedAt"></p-sortIcon>
        </th>
        <th style="min-width:10rem">Aktionen</th>
      </tr>
      <tr>
        <th>
          <input 
            pInputText 
            type="text" 
            (input)="dt.filter($any($event.target).value, 'displayName', 'contains')"
            placeholder="Filter..." 
            class="w-full" />
        </th>
        <th>
          <input 
            pInputText 
            type="text" 
            (input)="dt.filter($any($event.target).value, 'email', 'contains')"
            placeholder="Filter..." 
            class="w-full" />
        </th>
        <th></th>
        <th>
          <p-select 
            [options]="statusOptions" 
            (onChange)="dt.filter($event.value, 'active', 'equals')"
            placeholder="Alle"
            [showClear]="true"
            styleClass="w-full">
          </p-select>
        </th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="body" let-member>
      <tr>
        <td>
          <span *ngIf="member.color" class="member-color-swatch" [style.background-color]="member.color"></span>
          <strong>{{ member.displayName }}</strong>
        </td>
        <td>{{ member.email || '-' }}</td>
        <td>
          <p-tag *ngFor="let tag of member.tags" [value]="tag" severity="info" styleClass="mr-1 mb-1"></p-tag>
        </td>
        <td>
          <p-tag 
            [value]="member.active ? 'Aktiv' : 'Inaktiv'" 
            [severity]="member.active ? 'success' : 'secondary'">
          </p-tag>
        </td>
        <td>
          <p-button 
            [label]="getTopicCount(member.id).toString()" 
            icon="pi pi-list" 
            [rounded]="true" 
            [text]="true" 
            severity="info" 
            (onClick)="viewTopics(member)"
            [badge]="getTopicCount(member.id) > 0 ? '' : undefined">
          </p-button>
        </td>
        <td>{{ formatDate(member.updatedAt) }}</td>
        <td>
          <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="info" (onClick)="editMember(member)"></p-button>
          <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" (onClick)="confirmDelete(member)"></p-button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="text-center">
          <i class="pi pi-users empty-icon"></i>
          <p>Keine Teammitglieder gefunden</p>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Create/Edit Dialog -->
  <p-dialog 
    [(visible)]="memberDialog" 
    [style]="{width: '500px'}" 
    [header]="editMode ? 'Mitglied bearbeiten' : 'Neues Mitglied'" 
    [modal]="true"
    [closable]="true"
    styleClass="p-fluid">
    
    <ng-template pTemplate="content">
      <div class="form-grid">
        <!-- Display Name (required) -->
        <div class="field">
          <label for="displayName">Name *</label>
          <input 
            pInputText 
            id="displayName" 
            [(ngModel)]="member.displayName" 
            required 
            autofocus
            [class.ng-invalid]="submitted && !member.displayName"
            [class.ng-dirty]="submitted && !member.displayName" />
          <small class="p-error" *ngIf="submitted && !member.displayName">Name ist erforderlich.</small>
        </div>

        <!-- Email -->
        <div class="field">
          <label for="email">E-Mail</label>
          <input 
            pInputText 
            id="email" 
            [(ngModel)]="member.email"
            type="email" />
        </div>

        <!-- Tags -->
        <div class="field">
          <label for="tags">Tags</label>
          <p-autoComplete 
            id="tags" 
            [(ngModel)]="member.tags"
            [multiple]="true"
            [suggestions]="tagSuggestions"
            (completeMethod)="searchTags($event)"
            placeholder="Tags hinzufügen...">
          </p-autoComplete>
        </div>

        <!-- Color -->
        <div class="field">
          <label for="color">Farbe</label>
          <p-colorpicker [(ngModel)]="member.color" inputId="cp-hex" />
        </div>

        <!-- Active Status -->
        <div class="field-checkbox">
          <p-toggleswitch 
            [(ngModel)]="member.active" 
            inputId="active">
          </p-toggleswitch>
          <label for="active" class="ml-2">Aktiv</label>
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <p-button label="Abbrechen" icon="pi pi-times" [text]="true" (onClick)="hideDialog()"></p-button>
      <p-button label="Speichern" icon="pi pi-check" (onClick)="saveMember()" [loading]="saving"></p-button>
    </ng-template>
  </p-dialog>

  <!-- Topics by Member Dialog -->
  <p-dialog 
    [(visible)]="topicsDialog" 
    [style]="{width: '800px'}" 
    [header]="'Themen von ' + selectedMemberName"
    [modal]="true"
    [closable]="true">
    
    <ng-template pTemplate="content">
      <p-tabs value="0">
        <p-tablist>
          <p-tab value="0">Verantwortlich (R)</p-tab>
          <p-tab value="1">Consulted (C)</p-tab>
          <p-tab value="2">Informed (I)</p-tab>
        </p-tablist>
        <p-tabpanels>
          <p-tabpanel value="0">
            <p-table [value]="responsibleTopics" styleClass="p-datatable-sm">
              <ng-template pTemplate="header">
                <tr>
                  <th>Thema</th>
                  <th>Rolle</th>
                  <th>Gültigkeit</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-item>
                <tr>
                  <td>{{ item.topic.header }}</td>
                  <td><p-tag [value]="item.role" severity="info"></p-tag></td>
                  <td><p-tag [value]="getValidityBadge(item.topic)" [severity]="getValiditySeverity(item.topic)"></p-tag></td>
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="3" class="text-center text-secondary">Keine Themen in dieser Rolle</td>
                </tr>
              </ng-template>
            </p-table>
          </p-tabpanel>
          
          <p-tabpanel value="1">
            <p-table [value]="consultedTopics" styleClass="p-datatable-sm">
              <ng-template pTemplate="header">
                <tr>
                  <th>Thema</th>
                  <th>Gültigkeit</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-item>
                <tr>
                  <td>{{ item.topic.header }}</td>
                  <td><p-tag [value]="getValidityBadge(item.topic)" [severity]="getValiditySeverity(item.topic)"></p-tag></td>
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="2" class="text-center text-secondary">Keine Themen in dieser Rolle</td>
                </tr>
              </ng-template>
            </p-table>
          </p-tabpanel>
          
          <p-tabpanel value="2">
            <p-table [value]="informedTopics" styleClass="p-datatable-sm">
              <ng-template pTemplate="header">
                <tr>
                  <th>Thema</th>
                  <th>Gültigkeit</th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-item>
                <tr>
                  <td>{{ item.topic.header }}</td>
                  <td><p-tag [value]="getValidityBadge(item.topic)" [severity]="getValiditySeverity(item.topic)"></p-tag></td>
                </tr>
              </ng-template>
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="2" class="text-center text-secondary">Keine Themen in dieser Rolle</td>
                </tr>
              </ng-template>
            </p-table>
          </p-tabpanel>
        </p-tabpanels>
      </p-tabs>
    </ng-template>
  </p-dialog>

  <!-- Deactivate Offer Dialog -->
  <p-dialog 
    [(visible)]="deactivateDialog" 
    [style]="{width: '450px'}" 
    header="Mitglied wird verwendet"
    [modal]="true"
    [closable]="true">
    
    <ng-template pTemplate="content">
      <div class="deactivate-content">
        <i class="pi pi-exclamation-triangle warning-icon"></i>
        <p>
          Das Mitglied <strong>{{ memberToDelete?.displayName }}</strong> ist {{ getTopicCount(memberToDelete?.id || '') }} Themen zugeordnet 
          und kann daher nicht gelöscht werden.
        </p>
        <p>Möchten Sie das Mitglied stattdessen deaktivieren?</p>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <p-button label="Abbrechen" icon="pi pi-times" [text]="true" (onClick)="deactivateDialog = false"></p-button>
      <p-button label="Deaktivieren" icon="pi pi-user-minus" severity="warn" (onClick)="deactivateMember()" [loading]="saving"></p-button>
    </ng-template>
  </p-dialog>
</div>
