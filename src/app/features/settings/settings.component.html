<div class="page-container">
  <h1>Einstellungen / Status</h1>

  <!-- Connection Status Card -->
  <p-card header="Verbindungsstatus" styleClass="mb-4">
    <div class="status-grid">
      <div class="status-row">
        <span class="status-label">Backend-Typ:</span>
        <p-tag [value]="backendTypeDisplay" [severity]="isConnected ? 'success' : 'secondary'"></p-tag>
      </div>
      <div class="status-row">
        <span class="status-label">Verbindungsstatus:</span>
        <p-tag [value]="isConnected ? 'Verbunden' : 'Nicht verbunden'" [severity]="isConnected ? 'success' : 'danger'"></p-tag>
      </div>
      @if (dataDirectoryName) {
        <div class="status-row">
          <span class="status-label">Datenverzeichnis:</span>
          <span class="status-value">{{ dataDirectoryName }}</span>
        </div>
      }
      @if (datastoreInfo) {
        <div class="status-row">
          <span class="status-label">Datenstand:</span>
          <span class="status-value">{{ datastoreInfo }}</span>
        </div>
      }
      @if (topicsCount !== null) {
        <div class="status-row">
          <span class="status-label">Themen:</span>
          <span class="status-value">{{ topicsCount }}</span>
        </div>
      }
      @if (membersCount !== null) {
        <div class="status-row">
          <span class="status-label">Teammitglieder:</span>
          <span class="status-value">{{ membersCount }}</span>
        </div>
      }
    </div>
  </p-card>

  <!-- Data Directory Card -->
  <p-card header="Datenverzeichnis" styleClass="mb-4">
    <p class="mb-3">
      Wählen Sie ein Verzeichnis für die Datenspeicherung. 
      Das Verzeichnis sollte für alle Benutzer zugänglich sein (z.B. SMB-Freigabe).
    </p>
    
    <div class="action-row mb-3">
      <p-button 
        label="Verzeichnis auswählen" 
        icon="pi pi-folder-open" 
        (onClick)="selectDataDirectory()"
        [loading]="isConnecting"
        severity="primary">
      </p-button>
      @if (dataDirectoryName) {
        <span class="current-dir">
          <i class="pi pi-check-circle check-icon"></i>
          {{ dataDirectoryName }}
        </span>
      }
    </div>

    @if (!isConnected) {
      <p-message severity="info">
        Bitte wählen Sie ein Datenverzeichnis aus, um die Anwendung zu verwenden.
      </p-message>
    }

    <p-divider></p-divider>

    <h4>Verzeichnis initialisieren</h4>
    <p class="mb-3">
      Wenn das ausgewählte Verzeichnis leer ist, können Sie es mit den erforderlichen Dateien initialisieren.
    </p>
    
    <p-button 
      label="Verzeichnis initialisieren (Bootstrap)" 
      icon="pi pi-refresh" 
      (onClick)="bootstrapDataDirectory()"
      [disabled]="!isConnected || !canBootstrap"
      [loading]="isBootstrapping"
      severity="secondary">
    </p-button>
    
    @if (isConnected && !canBootstrap) {
      <p-message severity="warn" styleClass="mt-3">
        Das Verzeichnis enthält bereits Daten. Ein Bootstrap würde diese überschreiben.
      </p-message>
    }
    @if (bootstrapMessage) {
      <p-message [severity]="bootstrapMessageSeverity" styleClass="mt-3">
        {{ bootstrapMessage }}
      </p-message>
    }
  </p-card>

  <!-- Backend Type Selection Card -->
  <p-card header="Backend-Konfiguration" styleClass="mb-4">
    <p class="mb-3">
      Wählen Sie den Backend-Typ für die Datenspeicherung. 
      <strong>Hinweis:</strong> Um den Backend-Typ dauerhaft zu ändern, 
      muss die Anwendung neu konfiguriert werden (siehe BACKEND_MIGRATION.md).
    </p>
    
    <div class="backend-selector mb-3">
      <p-selectButton 
        [options]="backendOptions" 
        [(ngModel)]="selectedBackendType"
        [disabled]="true"
        optionLabel="label" 
        optionValue="value">
      </p-selectButton>
    </div>

    <p-message severity="info">
      Der Backend-Typ ist derzeit auf <strong>{{ backendTypeDisplay }}</strong> festgelegt. 
      Um zum REST-Backend zu wechseln, folgen Sie der Anleitung in BACKEND_MIGRATION.md.
    </p-message>

    <p-divider></p-divider>

    <h4>REST API Konfiguration (Platzhalter)</h4>
    <p class="mb-3 text-muted">
      Diese Funktion wird in einer zukünftigen Version verfügbar sein.
      Wenn aktiviert, können Sie hier die URL des REST-Backends konfigurieren.
    </p>
    <div class="rest-config-placeholder">
      <label>API Base URL:</label>
      <input type="text" class="rest-url-input" value="/api" disabled placeholder="https://api.example.com/api" />
      <p-button 
        label="Verbindung testen" 
        icon="pi pi-check" 
        severity="secondary"
        [disabled]="true"
        size="small">
      </p-button>
    </div>
  </p-card>

  <!-- Diagnostics Card -->
  <p-card header="Diagnose" styleClass="mb-4">
    <div class="status-grid">
      <div class="status-row">
        <span class="status-label">Browser:</span>
        <span class="status-value">{{ browserInfo }}</span>
      </div>
      <div class="status-row">
        <span class="status-label">File System Access API:</span>
        <p-tag [value]="hasFileSystemAPI ? 'Unterstützt' : 'Nicht unterstützt'" [severity]="hasFileSystemAPI ? 'success' : 'danger'"></p-tag>
      </div>
      <div class="status-row">
        <span class="status-label">App Version:</span>
        <span class="status-value">0.0.0</span>
      </div>
    </div>
  </p-card>

  <!-- Queue Card -->
  <p-card header="Warteschlange" styleClass="mb-4">
    <div class="queue-summary mb-3">
      <div class="status-row">
        <span class="status-label">Ausstehende Änderungen:</span>
        <p-tag [value]="pendingChangesCount().toString()" [severity]="pendingChangesCount() > 0 ? 'warn' : 'success'"></p-tag>
      </div>
      @if (lastSaveTime()) {
        <div class="status-row">
          <span class="status-label">Letzte Speicherung:</span>
          <span class="status-value-muted">{{ formatLastSaveTime(lastSaveTime()) }}</span>
        </div>
      }
      @if (isSaving()) {
        <div class="status-row">
          <span class="status-label">Status:</span>
          <p-tag value="Wird gespeichert..." severity="info" icon="pi pi-spin pi-spinner"></p-tag>
        </div>
      }
    </div>

    <p-divider></p-divider>

    @if (pendingChangesCount() === 0) {
      <p-message severity="success" styleClass="mb-3">
        Keine ausstehenden Änderungen
      </p-message>
    } @else {
      <div class="queue-list mb-3">
        <h4>Ausstehende Operationen</h4>
        @for (operation of queuedOperations(); track operation.id) {
          <div class="queue-item">
            <div class="queue-item-header">
              <p-tag 
                [value]="getOperationTypeLabel(operation.type)" 
                [severity]="getOperationTypeInfo(operation.type).severity"
                [icon]="'pi ' + getOperationTypeInfo(operation.type).icon">
              </p-tag>
              <span class="queue-item-timestamp">{{ formatTimestamp(operation.timestamp) }}</span>
            </div>
            <div class="queue-item-description">
              {{ operation.description }}
            </div>
          </div>
        }
      </div>
    }

    <div class="queue-actions">
      <p-button 
        label="Jetzt speichern" 
        icon="pi pi-save" 
        (onClick)="saveNow()"
        [disabled]="pendingChangesCount() === 0 || isSaving()"
        [loading]="isSaving()"
        severity="primary">
      </p-button>
      <p-button 
        label="Warteschlange leeren" 
        icon="pi pi-trash" 
        (onClick)="clearQueue()"
        [disabled]="pendingChangesCount() === 0 || isSaving()"
        severity="danger"
        [outlined]="true">
      </p-button>
    </div>
  </p-card>

  <p-confirmDialog></p-confirmDialog>
</div>
