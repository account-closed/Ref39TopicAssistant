<div class="page-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <div class="page-header">
    <h1>Tags verwalten</h1>
    <p>Erstellen, bearbeiten und löschen Sie Tags für die Themenzuordnung</p>
  </div>

  <p-toolbar styleClass="mb-4">
    <ng-template #start>
      <p-button 
        label="Neuer Tag" 
        icon="pi pi-plus" 
        severity="primary" 
        (onClick)="openNewDialog()"
        [disabled]="!isConnected">
      </p-button>
    </ng-template>
    <ng-template #end>
      <p-iconfield>
        <p-inputicon styleClass="pi pi-search" />
        <input 
          pInputText 
          type="text" 
          [(ngModel)]="globalFilter" 
          (input)="onGlobalFilter($event)" 
          placeholder="Suche..." />
      </p-iconfield>
    </ng-template>
  </p-toolbar>

  <div class="card" *ngIf="!isConnected">
    <p class="text-center text-secondary">
      <i class="pi pi-info-circle"></i>
      Bitte verbinden Sie zuerst ein Datenverzeichnis über die Einstellungen.
    </p>
  </div>

  <p-table 
    #dt
    *ngIf="isConnected"
    [value]="tags" 
    [paginator]="true" 
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [globalFilterFields]="['name', 'hinweise', 'searchKeywordsString', 'createdByName']"
    [sortField]="'name'"
    [sortOrder]="1"
    styleClass="p-datatable-striped"
    [tableStyle]="{'min-width': '60rem'}">
    
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="name" style="min-width:12rem">
          Tag <p-sortIcon field="name"></p-sortIcon>
        </th>
        <th style="min-width:12rem">Suchbegriffe</th>
        <th style="min-width:14rem">Hinweise</th>
        <th style="min-width:8rem">Copy-Paste</th>
        <th style="min-width:6rem">Verwendung</th>
        <th pSortableColumn="createdByName" style="min-width:10rem">
          Erstellt von <p-sortIcon field="createdByName"></p-sortIcon>
        </th>
        <th pSortableColumn="modifiedAt" style="min-width:10rem">
          Aktualisiert <p-sortIcon field="modifiedAt"></p-sortIcon>
        </th>
        <th style="min-width:8rem">Aktionen</th>
      </tr>
      <tr>
        <th>
          <input 
            pInputText 
            type="text" 
            (input)="dt.filter($any($event.target).value, 'name', 'contains')"
            placeholder="Filter..." 
            class="w-full" />
        </th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="body" let-tag>
      <tr>
        <td>
          <p-tag [value]="tag.name" severity="info" [style]="tag.color ? {'background-color': tag.color} : {}"></p-tag>
          <i *ngIf="tag.isSuperTag" class="pi pi-star ml-1" pTooltip="Super-Tag" tooltipPosition="top"></i>
          <i *ngIf="tag.isGvplTag" class="pi pi-briefcase ml-1" pTooltip="GVPl-Tag" tooltipPosition="top"></i>
          <i *ngIf="tag.tagWeight && tag.tagWeight !== 0" 
             class="pi ml-1" 
             [class.pi-arrow-up]="tag.tagWeight > 0" 
             [class.pi-arrow-down]="tag.tagWeight < 0"
             [style.color]="tag.tagWeight > 0 ? 'var(--p-orange-500)' : 'var(--p-blue-500)'"
             [pTooltip]="'Gewichtung: ' + tag.tagWeight" 
             tooltipPosition="top"></i>
        </td>
        <td>
          <span *ngFor="let kw of tag.searchKeywords; let last = last">
            {{ kw }}{{ !last ? ', ' : '' }}
          </span>
          <span *ngIf="!tag.searchKeywords || tag.searchKeywords.length === 0" class="text-secondary">-</span>
        </td>
        <td>
          <span *ngIf="tag.hinweise" class="hinweise-cell" [pTooltip]="tag.hinweise" tooltipPosition="top">
            {{ tag.hinweise | slice:0:50 }}{{ (tag.hinweise?.length || 0) > 50 ? '...' : '' }}
          </span>
          <span *ngIf="!tag.hinweise" class="text-secondary">-</span>
        </td>
        <td>
          <p-button 
            *ngIf="tag.copyPasteText"
            icon="pi pi-copy" 
            [rounded]="true" 
            [text]="true" 
            severity="secondary" 
            (onClick)="copyToClipboard(tag.copyPasteText)"
            [pTooltip]="tag.copyPasteText"
            tooltipPosition="top">
          </p-button>
          <span *ngIf="!tag.copyPasteText" class="text-secondary">-</span>
        </td>
        <td>
          <p-tag [value]="getUsageCount(tag.name).toString()" [severity]="getUsageCount(tag.name) > 0 ? 'success' : 'secondary'"></p-tag>
        </td>
        <td>{{ tag.createdByName || 'Unbekannt' }}</td>
        <td>{{ formatDate(tag.modifiedAt) }}</td>
        <td>
          <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="info" (onClick)="editTag(tag)"></p-button>
          <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" (onClick)="confirmDelete(tag)"></p-button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="8" class="text-center">
          <i class="pi pi-tags empty-icon"></i>
          <p>Keine Tags gefunden</p>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Create/Edit Dialog -->
  <p-dialog 
    [(visible)]="tagDialog" 
    [style]="{width: '600px'}" 
    [header]="editMode ? 'Tag bearbeiten' : 'Neuer Tag'" 
    [modal]="true"
    [closable]="true"
    styleClass="p-fluid">
    
    <ng-template pTemplate="content">
      <div class="form-grid">
        <!-- Name (required) -->
        <div class="field">
          <label for="name">Tag Name *</label>
          <input 
            pInputText 
            id="name" 
            [(ngModel)]="tag.name" 
            (input)="onTagNameInput($event)"
            required 
            autofocus
            [class.ng-invalid]="submitted && (!tag.name || !isValidTagName())"
            [class.ng-dirty]="submitted && (!tag.name || !isValidTagName())" />
          <small class="hint">Keine Leerzeichen oder Sonderzeichen (erlaubt: _ - .)</small>
          <small class="p-error" *ngIf="submitted && !tag.name">Tag Name ist erforderlich.</small>
          <small class="p-error" *ngIf="submitted && tag.name && isValidTagName() && isDuplicateName()">Ein Tag mit diesem Namen existiert bereits.</small>
        </div>

        <!-- Search Keywords -->
        <div class="field">
          <label for="searchKeywords">Suchbegriffe</label>
          <p-autoComplete 
            id="searchKeywords" 
            [(ngModel)]="tag.searchKeywords"
            [multiple]="true"
            [suggestions]="keywordSuggestions"
            (completeMethod)="searchKeywords($event)"
            (onAdd)="onKeywordAdd($event)"
            [addOnBlur]="true"
            [addOnTab]="true"
            [unique]="true"
            placeholder="Suchbegriffe hinzufügen...">
          </p-autoComplete>
          <small class="hint">Keine Leerzeichen oder Sonderzeichen (erlaubt: _ - .)</small>
        </div>

        <!-- Hinweise -->
        <div class="field">
          <label for="hinweise">Hinweise</label>
          <textarea 
            pTextarea 
            id="hinweise" 
            [(ngModel)]="tag.hinweise" 
            rows="3"
            [autoResize]="true"
            placeholder="Hinweise zur Verwendung dieses Tags...">
          </textarea>
          <small class="hint">Hinweise und Tipps zur korrekten Verwendung dieses Tags</small>
        </div>

        <!-- Copy-Paste Text -->
        <div class="field">
          <label for="copyPasteText">Copy-Paste Text</label>
          <textarea 
            pTextarea 
            id="copyPasteText" 
            [(ngModel)]="tag.copyPasteText" 
            rows="3"
            [autoResize]="true"
            placeholder="Text zum Kopieren...">
          </textarea>
          <small class="hint">Vorlagen-Text zum schnellen Kopieren in die Zwischenablage</small>
        </div>

        <!-- Color -->
        <div class="field">
          <label for="color">Farbe</label>
          <p-colorpicker [(ngModel)]="tag.color" inputId="cp-hex" />
        </div>

        <!-- TagWeight -->
        <div class="field">
          <label for="tagWeight">
            Gewichtung
            <i class="pi pi-info-circle ml-1" 
               pTooltip="Beeinflusst die Auslastungsberechnung. Neutral = 0, höhere Werte erhöhen die Komplexität von Themen mit diesem Tag. Empfohlener Bereich: -1.0 bis +2.0"
               tooltipPosition="top"></i>
          </label>
          <div class="tag-weight-input">
            <input 
              pInputText 
              type="number" 
              id="tagWeight" 
              [(ngModel)]="tag.tagWeight"
              step="0.1"
              placeholder="0 (neutral)"
              [class.extreme-value]="isExtremeTagWeight()"
              style="width: 100px" />
            <span class="weight-indicator" *ngIf="tag.tagWeight !== null && tag.tagWeight !== undefined && tag.tagWeight !== 0">
              <i class="pi" [class.pi-arrow-up]="tag.tagWeight > 0" [class.pi-arrow-down]="tag.tagWeight < 0"
                 [style.color]="tag.tagWeight > 0 ? 'var(--p-orange-500)' : 'var(--p-blue-500)'"></i>
              {{ tag.tagWeight > 0 ? 'Erhöht' : 'Reduziert' }} Komplexität
            </span>
          </div>
          <small class="hint">Optional. Leere oder 0 = neutral (kein Einfluss auf Auslastung)</small>
          <small class="p-error" *ngIf="isExtremeTagWeight()">
            Extreme Gewichtung (außerhalb -1.0 bis +2.0). Dies kann zu unerwarteten Auslastungswerten führen.
          </small>
        </div>

        <!-- Tag Type Toggles -->
        <div class="field-group">
          <h4>Tag-Typ</h4>
          
          <div class="field-checkbox">
            <p-toggleswitch 
              [(ngModel)]="tag.isSuperTag" 
              inputId="isSuperTag">
            </p-toggleswitch>
            <label for="isSuperTag" class="ml-2">Super-Tag (Übergeordneter Tag)</label>
          </div>

          <div class="field-checkbox">
            <p-toggleswitch 
              [(ngModel)]="tag.isGvplTag" 
              inputId="isGvplTag">
            </p-toggleswitch>
            <label for="isGvplTag" class="ml-2">GVPl-Tag (Geschäftsverteilungsplan)</label>
          </div>
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <p-button label="Abbrechen" icon="pi pi-times" [text]="true" (onClick)="hideDialog()"></p-button>
      <p-button label="Speichern" icon="pi pi-check" (onClick)="saveTag()" [loading]="saving"></p-button>
    </ng-template>
  </p-dialog>
</div>
