<div class="page-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <div class="page-header">
    <h1>Themen verwalten</h1>
    <p>Erstellen, bearbeiten und löschen Sie Themen für die RACI-Zuordnung</p>
  </div>

  <p-toolbar styleClass="mb-4">
    <ng-template #start>
      <p-button 
        label="Neues Thema" 
        icon="pi pi-plus" 
        severity="primary" 
        (onClick)="openNewDialog()"
        [disabled]="!isConnected">
      </p-button>
    </ng-template>
    <ng-template #end>
      <p-iconfield>
        <p-inputicon styleClass="pi pi-search" />
        <input 
          pInputText 
          type="text" 
          [(ngModel)]="globalFilter" 
          (input)="onGlobalFilter($event)" 
          placeholder="Suche..." />
      </p-iconfield>
    </ng-template>
  </p-toolbar>

  <div class="card" *ngIf="!isConnected">
    <p class="text-center text-secondary">
      <i class="pi pi-info-circle"></i>
      Bitte verbinden Sie zuerst ein Datenverzeichnis über die Einstellungen.
    </p>
  </div>

  <p-table 
    #dt
    *ngIf="isConnected"
    [value]="topics" 
    [paginator]="true" 
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [globalFilterFields]="['header', 'description', 'tagsString', 'r1Name']"
    [sortField]="'updatedAt'"
    [sortOrder]="-1"
    styleClass="p-datatable-striped"
    [tableStyle]="{'min-width': '60rem'}">
    
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="header" style="min-width:14rem">
          Thema <p-sortIcon field="header"></p-sortIcon>
        </th>
        <th pSortableColumn="r1Name" style="min-width:10rem">
          R1 <p-sortIcon field="r1Name"></p-sortIcon>
        </th>
        <th style="min-width:10rem">Tags</th>
        <th style="min-width:8rem">Gültigkeit</th>
        <th pSortableColumn="updatedAt" style="min-width:10rem">
          Aktualisiert <p-sortIcon field="updatedAt"></p-sortIcon>
        </th>
        <th style="min-width:8rem">Aktionen</th>
      </tr>
      <tr>
        <th>
          <input 
            pInputText 
            type="text" 
            [(ngModel)]="filterHeader"
            (input)="dt.filter($any($event.target).value, 'header', 'contains')"
            placeholder="Filter..." 
            class="w-full" />
        </th>
        <th>
          <p-select 
            [options]="memberOptions" 
            [(ngModel)]="filterR1"
            (onChange)="dt.filter($event.value, 'r1MemberId', 'equals')"
            optionLabel="displayName" 
            optionValue="id"
            placeholder="Alle"
            [showClear]="true"
            styleClass="w-full">
          </p-select>
        </th>
        <th>
          <p-multiSelect 
            [options]="allTags" 
            [(ngModel)]="filterTags"
            (onChange)="filterByTags()"
            placeholder="Filter Tags"
            styleClass="w-full">
          </p-multiSelect>
        </th>
        <th>
          <p-select 
            [options]="validityOptions" 
            [(ngModel)]="filterValidity"
            (onChange)="filterByValidity()"
            placeholder="Alle"
            [showClear]="true"
            styleClass="w-full">
          </p-select>
        </th>
        <th></th>
        <th></th>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="body" let-topic>
      <tr>
        <td>
          <strong>{{ topic.header }}</strong>
          <div class="text-secondary text-sm" *ngIf="topic.description">
            {{ topic.description | slice:0:100 }}{{ topic.description.length > 100 ? '...' : '' }}
          </div>
        </td>
        <td>{{ getMemberName(topic.raci.r1MemberId) }}</td>
        <td>
          <p-tag *ngFor="let tag of topic.tags" [value]="tag" severity="info" styleClass="mr-1 mb-1"></p-tag>
        </td>
        <td>
          <p-tag [value]="getValidityBadge(topic)" [severity]="getValiditySeverity(topic)"></p-tag>
        </td>
        <td>{{ formatDate(topic.updatedAt) }}</td>
        <td>
          <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="info" (onClick)="editTopic(topic)"></p-button>
          <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger" (onClick)="confirmDelete(topic)"></p-button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center">
          <i class="pi pi-inbox empty-icon"></i>
          <p>Keine Themen gefunden</p>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Create/Edit Dialog -->
  <p-dialog 
    [(visible)]="topicDialog" 
    [style]="{width: '700px'}" 
    [header]="editMode ? 'Thema bearbeiten' : 'Neues Thema'" 
    [modal]="true"
    [closable]="true"
    styleClass="p-fluid">
    
    <ng-template pTemplate="content">
      <div class="form-grid">
        <!-- Header (required) -->
        <div class="field">
          <label for="header">Thema *</label>
          <input 
            pInputText 
            id="header" 
            [(ngModel)]="topic.header" 
            required 
            autofocus
            [class.ng-invalid]="submitted && !topic.header"
            [class.ng-dirty]="submitted && !topic.header" />
          <small class="p-error" *ngIf="submitted && !topic.header">Thema ist erforderlich.</small>
        </div>

        <!-- Description -->
        <div class="field">
          <label for="description">Beschreibung</label>
          <textarea 
            pTextarea 
            id="description" 
            [(ngModel)]="topic.description" 
            rows="3"
            [autoResize]="true">
          </textarea>
        </div>

        <!-- Tags -->
        <div class="field">
          <label for="tags">Tags</label>
          <p-autoComplete 
            id="tags" 
            [(ngModel)]="topic.tags"
            [multiple]="true"
            [suggestions]="tagSuggestions"
            (completeMethod)="searchTags($event)"
            [dropdown]="true"
            [forceSelection]="managedTagsExist"
            placeholder="Tags auswählen...">
            <ng-template let-tag pTemplate="item">
              <div class="tag-suggestion-item">
                <span class="tag-name">{{ tag }}</span>
                <span class="tag-hinweise" *ngIf="getTagHinweise(tag)">{{ getTagHinweise(tag) }}</span>
              </div>
            </ng-template>
          </p-autoComplete>
          <small class="hint" *ngIf="managedTagsExist">Nur verwaltete Tags können zugewiesen werden</small>
          <small class="hint" *ngIf="!managedTagsExist">Erstellen Sie Tags unter "Tags verwalten"</small>
        </div>

        <!-- Search Keywords -->
        <div class="field">
          <label for="searchKeywords">Suchbegriffe</label>
          <p-autoComplete 
            id="searchKeywords" 
            [(ngModel)]="topic.searchKeywords"
            [multiple]="true"
            [suggestions]="keywordSuggestions"
            (completeMethod)="searchKeywords($event)"
            placeholder="Suchbegriffe hinzufügen...">
          </p-autoComplete>
        </div>

        <!-- Notes -->
        <div class="field">
          <label for="notes">Notizen</label>
          <textarea 
            pTextarea 
            id="notes" 
            [(ngModel)]="topic.notes" 
            rows="2"
            [autoResize]="true">
          </textarea>
        </div>

        <!-- Validity Section -->
        <div class="field-group">
          <h4>Gültigkeit</h4>
          
          <div class="field-checkbox">
            <p-toggleswitch 
              [(ngModel)]="topic.validity.alwaysValid" 
              inputId="alwaysValid"
              (onChange)="onAlwaysValidChange()">
            </p-toggleswitch>
            <label for="alwaysValid" class="ml-2">Immer gültig</label>
          </div>

          <div class="validity-dates" *ngIf="!topic.validity.alwaysValid">
            <div class="field">
              <label for="validFrom">Gültig ab *</label>
              <p-datepicker 
                id="validFrom" 
                [(ngModel)]="validFromDate"
                dateFormat="dd.mm.yy"
                [showIcon]="true"
                [required]="!topic.validity.alwaysValid"
                [class.ng-invalid]="submitted && !topic.validity.alwaysValid && !validFromDate"
                [class.ng-dirty]="submitted && !topic.validity.alwaysValid && !validFromDate">
              </p-datepicker>
              <small class="p-error" *ngIf="submitted && !topic.validity.alwaysValid && !validFromDate">
                Gültig ab ist erforderlich.
              </small>
            </div>

            <div class="field">
              <label for="validTo">Gültig bis (optional)</label>
              <p-datepicker 
                id="validTo" 
                [(ngModel)]="validToDate"
                dateFormat="dd.mm.yy"
                [showIcon]="true">
              </p-datepicker>
            </div>
          </div>
        </div>

        <!-- RACI Section -->
        <div class="field-group">
          <h4>Verantwortliche</h4>

          <div class="field">
            <label for="r1">R1 (Hauptverantwortlich) *</label>
            <p-select 
              id="r1"
              [options]="activeMembers" 
              [(ngModel)]="topic.raci.r1MemberId"
              optionLabel="displayName" 
              optionValue="id"
              placeholder="R1 auswählen..."
              [filter]="true"
              filterBy="displayName"
              [required]="true"
              [class.ng-invalid]="submitted && !topic.raci.r1MemberId"
              [class.ng-dirty]="submitted && !topic.raci.r1MemberId">
            </p-select>
            <small class="p-error" *ngIf="submitted && !topic.raci.r1MemberId">R1 ist erforderlich.</small>
          </div>

          <div class="field">
            <label for="r2">R2 (Stellvertretung)</label>
            <p-select 
              id="r2"
              [options]="activeMembers" 
              [(ngModel)]="topic.raci.r2MemberId"
              optionLabel="displayName" 
              optionValue="id"
              placeholder="R2 auswählen..."
              [filter]="true"
              filterBy="displayName"
              [showClear]="true">
            </p-select>
          </div>

          <div class="field">
            <label for="r3">R3 (Weitere Stellvertretung)</label>
            <p-select 
              id="r3"
              [options]="activeMembers" 
              [(ngModel)]="topic.raci.r3MemberId"
              optionLabel="displayName" 
              optionValue="id"
              placeholder="R3 auswählen..."
              [filter]="true"
              filterBy="displayName"
              [showClear]="true">
            </p-select>
          </div>

          <div class="field">
            <label for="consulted">Consulted (C)</label>
            <p-multiSelect 
              id="consulted"
              [options]="activeMembers" 
              [(ngModel)]="topic.raci.cMemberIds"
              optionLabel="displayName" 
              optionValue="id"
              placeholder="Consulted auswählen..."
              [filter]="true"
              filterBy="displayName">
            </p-multiSelect>
          </div>

          <div class="field">
            <label for="informed">Informed (I)</label>
            <p-multiSelect 
              id="informed"
              [options]="activeMembers" 
              [(ngModel)]="topic.raci.iMemberIds"
              optionLabel="displayName" 
              optionValue="id"
              placeholder="Informed auswählen..."
              [filter]="true"
              filterBy="displayName">
            </p-multiSelect>
          </div>
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="footer">
      <p-button label="Abbrechen" icon="pi pi-times" [text]="true" (onClick)="hideDialog()"></p-button>
      <p-button label="Speichern" icon="pi pi-check" (onClick)="saveTopic()" [loading]="saving"></p-button>
    </ng-template>
  </p-dialog>
</div>
