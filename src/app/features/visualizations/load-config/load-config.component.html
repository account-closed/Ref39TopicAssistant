<div class="page-container">
  <p-toast></p-toast>
  
  <div class="page-header">
    <div class="header-content">
      <button class="back-button" routerLink="/visualizations/load">
        <i class="pi pi-arrow-left"></i>
      </button>
      <div>
        <h1>
          <i class="pi pi-cog"></i>
          Auslastungs-Konfiguration
        </h1>
        <p>Konfiguration der Berechnungsparameter für die Auslastungsanalyse</p>
      </div>
    </div>
    <div class="header-actions">
      <p-button 
        label="Zurücksetzen" 
        icon="pi pi-refresh" 
        severity="secondary"
        [outlined]="true"
        (onClick)="resetToDefaults()"></p-button>
      <p-button 
        label="Speichern" 
        icon="pi pi-save" 
        [loading]="isSaving()"
        (onClick)="saveConfig()"></p-button>
    </div>
  </div>

  @if (!isConnected()) {
    <div class="card">
      <p class="text-center text-secondary">
        <i class="pi pi-info-circle"></i>
        Bitte verbinden Sie zuerst ein Datenverzeichnis über die Einstellungen.
      </p>
    </div>
  } @else if (!config()) {
    <div class="card">
      <p class="text-center text-secondary">
        <i class="pi pi-spin pi-spinner"></i>
        Lade Konfiguration...
      </p>
    </div>
  } @else {
    <div class="config-grid">
      <!-- Capacity Settings -->
      <p-card styleClass="config-card">
        <ng-template #header>
          <div class="card-header">
            <h3><i class="pi pi-clock"></i> Kapazität</h3>
          </div>
        </ng-template>
        
        <div class="config-section">
          <div class="config-row">
            <label for="contractHours">Vertragsstunden pro Woche</label>
            <p-inputNumber 
              id="contractHours"
              [(ngModel)]="contractHours"
              [min]="1"
              [max]="60"
              suffix=" h"
              [showButtons]="true"
              pTooltip="Wöchentliche Arbeitszeit laut Vertrag"
              tooltipPosition="top"></p-inputNumber>
          </div>
          
          <div class="config-row">
            <label for="overheadFactor">Overhead-Faktor</label>
            <p-inputNumber 
              id="overheadFactor"
              [(ngModel)]="overheadFactor"
              [min]="0"
              [max]="maxOverheadFactor - 0.01"
              [step]="0.05"
              [minFractionDigits]="2"
              [maxFractionDigits]="2"
              [pTooltip]="'Anteil für Meetings, Admin etc. (max ' + (maxOverheadPercent - 1) + '%)'"
              tooltipPosition="top"></p-inputNumber>
            <span class="percent-display">= {{ overheadPercent() }}%</span>
          </div>
          
          <div class="summary-box">
            <strong>Effektive Kapazität (Vollzeit):</strong>
            <span class="highlight">{{ formatHoursMinutes(effectiveCapacity()) }}/Woche</span>
            <small>{{ contractHours() }}h × (1 - {{ (overheadFactor() * 100).toFixed(0) }}%)</small>
          </div>
        </div>
      </p-card>

      <!-- Topic Complexity Settings -->
      <p-card styleClass="config-card">
        <ng-template #header>
          <div class="card-header">
            <h3><i class="pi pi-calculator"></i> Themenkomplexität</h3>
          </div>
        </ng-template>
        
        <div class="config-section">
          <p class="formula-text">
            c(t) = 1 + α × TagWeight + β × Abhängigkeiten
          </p>
          
          <div class="config-row">
            <label for="alpha">α (Tag-Gewicht-Multiplikator)</label>
            <p-inputNumber 
              id="alpha"
              [(ngModel)]="alpha"
              [min]="0"
              [max]="5"
              [step]="0.1"
              [minFractionDigits]="1"
              [maxFractionDigits]="2"
              [showButtons]="true"
              pTooltip="Multiplikator für Tag-Gewichtungen"
              tooltipPosition="top"></p-inputNumber>
          </div>
          
          <div class="config-row">
            <label for="beta">β (Abhängigkeits-Multiplikator)</label>
            <p-inputNumber 
              id="beta"
              [(ngModel)]="beta"
              [min]="0"
              [max]="2"
              [step]="0.05"
              [minFractionDigits]="2"
              [maxFractionDigits]="2"
              [showButtons]="true"
              pTooltip="Multiplikator für Themenabhängigkeiten"
              tooltipPosition="top"></p-inputNumber>
          </div>
        </div>
      </p-card>

      <!-- Base Load Components -->
      <p-card styleClass="config-card full-width">
        <ng-template #header>
          <div class="card-header">
            <h3><i class="pi pi-calendar"></i> Basis-Auslastung (wiederkehrende Termine)</h3>
            <p-button 
              icon="pi pi-plus" 
              [rounded]="true" 
              [text]="true"
              (onClick)="addBaseComponent()"
              pTooltip="Neuen Termin hinzufügen"
              tooltipPosition="top"></p-button>
          </div>
        </ng-template>
        
        <div class="base-load-section">
          <p-table [value]="baseComponents()" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
              <tr>
                <th>Aktiv</th>
                <th>Name</th>
                <th>Stunden/Woche</th>
                <th></th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-component let-i="rowIndex">
              <tr>
                <td>
                  <p-toggleSwitch 
                    [ngModel]="component.enabled"
                    (ngModelChange)="updateComponentEnabled(i, $event)"></p-toggleSwitch>
                </td>
                <td>
                  <input 
                    type="text" 
                    class="p-inputtext p-component"
                    [value]="component.name"
                    (change)="updateComponentName(i, $any($event.target).value)">
                </td>
                <td>
                  <app-time-input
                    [ngModel]="component.hoursPerWeek"
                    (ngModelChange)="updateComponentHours(i, $event)"
                    [maxHours]="10"
                    [minuteStep]="15">
                  </app-time-input>
                </td>
                <td>
                  <p-button 
                    icon="pi pi-trash" 
                    severity="danger" 
                    [rounded]="true" 
                    [text]="true"
                    (onClick)="removeBaseComponent(i)"></p-button>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="footer">
              <tr class="total-row">
                <td colspan="2"><strong>Summe Basis-Auslastung:</strong></td>
                <td><strong>{{ formatHoursMinutes(totalBaseLoad()) }}/Woche</strong></td>
                <td></td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </p-card>

      <!-- Info about Member Settings -->
      <p-card styleClass="config-card full-width">
        <ng-template #header>
          <div class="card-header">
            <h3><i class="pi pi-users"></i> Mitglieder-Einstellungen</h3>
          </div>
        </ng-template>
        
        <div class="info-section">
          <p class="info-text">
            <i class="pi pi-info-circle"></i>
            Individuelle Einstellungen wie <strong>Teilzeitfaktor</strong> und <strong>Basislast-Überschreibung</strong>
            werden direkt beim Teammitglied unter 
            <a routerLink="/members" class="link">Teammitglieder verwalten</a> konfiguriert.
          </p>
        </div>
      </p-card>
      
      <!-- Role Weights Configuration -->
      <p-card styleClass="config-card full-width">
        <ng-template #header>
          <div class="card-header">
            <h3><i class="pi pi-users"></i> Rollen-Gewichtung</h3>
          </div>
        </ng-template>
        
        <div class="config-section">
          <p class="info-text">
            <i class="pi pi-info-circle"></i>
            Die Rollen-Gewichtung bestimmt, wie stark eine Rolle zur Gesamtauslastung beiträgt.
          </p>
          
          <div class="role-weights-grid">
            <div class="config-row">
              <label for="roleWeightR1">Hauptverantwortlicher (R1)</label>
              <p-inputNumber 
                id="roleWeightR1"
                [(ngModel)]="roleWeightR1"
                [min]="0"
                [max]="10"
                [step]="0.5"
                [minFractionDigits]="1"
                [showButtons]="true"
                pTooltip="Gewichtung für Hauptverantwortliche"
                tooltipPosition="top"></p-inputNumber>
            </div>
            
            <div class="config-row">
              <label for="roleWeightR2">Stellvertreter (R2)</label>
              <p-inputNumber 
                id="roleWeightR2"
                [(ngModel)]="roleWeightR2"
                [min]="0"
                [max]="10"
                [step]="0.5"
                [minFractionDigits]="1"
                [showButtons]="true"
                pTooltip="Gewichtung für Stellvertreter"
                tooltipPosition="top"></p-inputNumber>
            </div>
            
            <div class="config-row">
              <label for="roleWeightR3">Zweiter Stellvertreter (R3)</label>
              <p-inputNumber 
                id="roleWeightR3"
                [(ngModel)]="roleWeightR3"
                [min]="0"
                [max]="10"
                [step]="0.5"
                [minFractionDigits]="1"
                [showButtons]="true"
                pTooltip="Gewichtung für zweiten Stellvertreter"
                tooltipPosition="top"></p-inputNumber>
            </div>
            
            <div class="config-row">
              <label for="roleWeightC">Konsultiert (C)</label>
              <p-inputNumber 
                id="roleWeightC"
                [(ngModel)]="roleWeightC"
                [min]="0"
                [max]="10"
                [step]="0.5"
                [minFractionDigits]="1"
                [showButtons]="true"
                pTooltip="Gewichtung für zu konsultierende Personen"
                tooltipPosition="top"></p-inputNumber>
            </div>
            
            <div class="config-row">
              <label for="roleWeightI">Informiert (I)</label>
              <p-inputNumber 
                id="roleWeightI"
                [(ngModel)]="roleWeightI"
                [min]="0"
                [max]="10"
                [step]="0.5"
                [minFractionDigits]="1"
                [showButtons]="true"
                pTooltip="Gewichtung für zu informierende Personen"
                tooltipPosition="top"></p-inputNumber>
            </div>
          </div>
        </div>
      </p-card>
      
      <!-- Size Classification Configuration -->
      <p-card styleClass="config-card full-width">
        <ng-template #header>
          <div class="card-header">
            <h3><i class="pi pi-chart-bar"></i> Größen-Klassifizierung</h3>
          </div>
        </ng-template>
        
        <div class="config-section">
          <p class="info-text">
            <i class="pi pi-info-circle"></i>
            Definieren Sie die Schwellenwerte für die Klassifizierung der Themengröße.
            <strong>XXL</strong> wird automatisch für Themen vergeben, die die individuelle Kapazität eines Mitglieds überschreiten (nicht konfigurierbar).
          </p>
          
          <div class="size-thresholds-grid">
            <div class="config-row">
              <label>XXS (Extra Extra Small)</label>
              <div class="threshold-input">
                <span class="threshold-label">0min bis</span>
                <app-time-input
                  [(ngModel)]="sizeThresholdXXSMax"
                  [maxHours]="20"
                  [minuteStep]="15">
                </app-time-input>
              </div>
            </div>
            
            <div class="config-row">
              <label>XS (Extra Small)</label>
              <div class="threshold-input">
                <span class="threshold-label">{{ formatHoursMinutes(sizeThresholdXXSMax()) }} bis</span>
                <app-time-input
                  [(ngModel)]="sizeThresholdXSMax"
                  [maxHours]="20"
                  [minuteStep]="15">
                </app-time-input>
              </div>
            </div>
            
            <div class="config-row">
              <label>S (Small)</label>
              <div class="threshold-input">
                <span class="threshold-label">{{ formatHoursMinutes(sizeThresholdXSMax()) }} bis</span>
                <app-time-input
                  [(ngModel)]="sizeThresholdSMax"
                  [maxHours]="20"
                  [minuteStep]="15">
                </app-time-input>
              </div>
            </div>
            
            <div class="config-row">
              <label>M (Medium)</label>
              <div class="threshold-input">
                <span class="threshold-label">{{ formatHoursMinutes(sizeThresholdSMax()) }} bis</span>
                <app-time-input
                  [(ngModel)]="sizeThresholdMMax"
                  [maxHours]="30"
                  [minuteStep]="15">
                </app-time-input>
              </div>
            </div>
            
            <div class="config-row">
              <label>L (Large)</label>
              <div class="threshold-input">
                <span class="threshold-label">{{ formatHoursMinutes(sizeThresholdMMax()) }} bis</span>
                <app-time-input
                  [(ngModel)]="sizeThresholdLMax"
                  [maxHours]="40"
                  [minuteStep]="15">
                </app-time-input>
              </div>
            </div>
            
            <div class="config-row">
              <label>XL (Extra Large)</label>
              <div class="threshold-input">
                <span class="threshold-label">ab</span>
                <app-time-input
                  [(ngModel)]="sizeThresholdXLMin"
                  [maxHours]="100"
                  [minuteStep]="15">
                </app-time-input>
                <i class="pi pi-info-circle ml-2" 
                   pTooltip="Untere Grenze für XL (obere Grenze = Kapazität)"
                   tooltipPosition="top"></i>
              </div>
            </div>
          </div>
        </div>
      </p-card>
    </div>
  }
</div>
