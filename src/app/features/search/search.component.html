<div class="search-page">
  <p-toast></p-toast>

  <!-- Quick Connect Panel - shown when not connected -->
  <div class="quick-connect-panel" *ngIf="!isConnected">
    <p-card styleClass="connect-card">
      <div class="connect-content">
        <i class="pi pi-folder-open connect-icon"></i>
        <h2>Willkommen beim RACI Topic Finder</h2>
        <p>Um zu beginnen, verbinden Sie die Anwendung mit einem Datenverzeichnis.</p>
        <p class="connect-hint">
          Wählen Sie ein Verzeichnis auf einem gemeinsamen Netzlaufwerk (z.B. SMB-Freigabe),
          damit alle Teammitglieder auf die gleichen Daten zugreifen können.
        </p>
        
        <!-- Quick Reconnect Button - shown when there's a stored connection -->
        <p-button 
          *ngIf="hasStoredConnection"
          label="Letztes Verzeichnis wiederverwenden" 
          icon="pi pi-refresh" 
          (onClick)="quickReconnect()"
          [loading]="isConnecting"
          severity="success"
          size="large"
          styleClass="mb-2">
        </p-button>
        
        <p-button 
          [label]="hasStoredConnection ? 'Anderes Verzeichnis wählen' : 'Datenverzeichnis wählen'" 
          icon="pi pi-folder-open" 
          (onClick)="quickConnect()"
          [loading]="isConnecting"
          [severity]="hasStoredConnection ? 'secondary' : 'primary'"
          size="large">
        </p-button>
        <p-message *ngIf="!hasFileSystemAPI" severity="error" styleClass="mt-3">
          Ihr Browser unterstützt die File System Access API nicht. 
          Bitte verwenden Sie Chrome, Edge oder einen anderen Chromium-basierten Browser.
        </p-message>
        <p-message *ngIf="connectError" severity="error" styleClass="mt-3">
          {{ connectError }}
        </p-message>
      </div>
    </p-card>
  </div>

  <!-- Main search UI - shown when connected -->
  <div *ngIf="isConnected">
    <div class="search-header">
      <h1>Schnellsuche</h1>
      <p>Schnelle Themensuche mit Tastatursteuerung</p>
    </div>

    <!-- Keyboard Shortcuts Help -->
    <div class="keyboard-shortcuts-panel">
      <div class="shortcuts-group">
        <span class="shortcuts-title">Navigation:</span>
        <span class="shortcut-item"><kbd>↓</kbd><kbd>↑</kbd> Navigieren</span>
        <span class="shortcut-item"><kbd>Enter</kbd> Öffnen</span>
      </div>
    </div>

    <!-- Index Status Indicator -->
    <div class="index-status">
      <div class="index-status-indicator" *ngIf="isIndexBuilding">
        <p-progressSpinner 
          styleClass="index-spinner" 
          strokeWidth="4" 
          [style]="{'width': '20px', 'height': '20px'}">
        </p-progressSpinner>
        <span class="index-status-text">Suchindex wird erstellt...</span>
      </div>
      <div class="index-status-indicator ready" *ngIf="!isIndexBuilding && isIndexReady">
        <i class="pi pi-check-circle"></i>
        <span class="index-status-text">Suchindex bereit ({{ indexDocumentCount }} Themen)</span>
      </div>
      <div class="index-status-indicator waiting" *ngIf="!isIndexBuilding && !isIndexReady">
        <i class="pi pi-clock"></i>
        <span class="index-status-text">Warten auf Daten...</span>
      </div>
    </div>

    <div class="search-box">
      <span class="p-input-icon-left" style="width: 100%">
        <i class="pi pi-search"></i>
        <input 
          type="text" 
          pInputText 
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchChange($event)"
          (keydown)="onSearchKeydown($event)"
          placeholder="Thema suchen... (Fokus: automatisch)"
          style="width: 100%"
          #searchInput
          [disabled]="!isIndexReady" />
      </span>
    </div>

    <div class="search-results" *ngIf="searchResults.length > 0">
      <p class="results-count">{{ searchResults.length }} Thema(en) gefunden – <kbd>↓</kbd><kbd>↑</kbd> zum Navigieren, <kbd>Enter</kbd> zum Öffnen</p>
      
      <div class="result-list compact">
        <ng-container *ngFor="let result of searchResults; let i = index">
          <div *ngIf="result.topic"
               [ngClass]="{'selected': i === selectedIndex}"
               (click)="selectAndOpenResult(i)"
               class="result-item">
            
            <!-- Header Line -->
            <div class="result-header-compact">
              <h3 class="topic-title-compact">{{ result.topic.header }}</h3>
              <p-tag [value]="getValidityBadge(result.topic)" 
                     [severity]="getValiditySeverity(result.topic)"
                     styleClass="validity-tag-compact">
              </p-tag>
            </div>
            
            <!-- Description Line -->
            <p *ngIf="result.topic.description" class="description-compact">
              {{ result.topic.description }}
            </p>

            <!-- Compact RACI Line -->
            <div class="raci-line" *ngIf="result.topic.raci">
              <span class="raci-item r1">
                <span class="raci-badge-compact r-badge-compact">R1</span>
                <span class="raci-name">{{ getMemberName(result.topic.raci.r1MemberId) }}</span>
              </span>
              <span class="raci-item" *ngIf="result.topic.raci.r2MemberId">
                <span class="raci-badge-compact r-badge-compact">R2</span>
                <span class="raci-name">{{ getMemberName(result.topic.raci.r2MemberId) }}</span>
              </span>
              <span class="raci-item" *ngIf="result.topic.raci.r3MemberId">
                <span class="raci-badge-compact r-badge-compact">R3</span>
                <span class="raci-name">{{ getMemberName(result.topic.raci.r3MemberId) }}</span>
              </span>
              <span class="raci-item" *ngIf="result.topic.raci.iMemberIds && result.topic.raci.iMemberIds.length > 0">
                <span class="raci-badge-compact i-badge-compact">I</span>
                <span class="raci-name">{{ getMembersDisplay(result.topic.raci.iMemberIds) }}</span>
              </span>
              <span class="raci-item" *ngIf="result.topic.raci.cMemberIds && result.topic.raci.cMemberIds.length > 0">
                <span class="raci-badge-compact c-badge-compact">C</span>
                <span class="raci-name">{{ getMembersDisplay(result.topic.raci.cMemberIds) }}</span>
              </span>
            </div>
          </div>
        </ng-container>
      </div>
    </div>

    <div class="no-results" *ngIf="searchQuery && searchResults.length === 0 && isIndexReady">
      <i class="pi pi-search"></i>
      <p>Keine Themen gefunden</p>
    </div>

    <div class="empty-state" *ngIf="!searchQuery && isIndexReady">
      <i class="pi pi-search"></i>
      <p>Geben Sie einen Suchbegriff ein, um Themen zu finden</p>
      <p class="keyboard-hints">
        <span class="hint"><strong>↓/↑:</strong> Navigieren</span>
        <span class="hint"><strong>Enter:</strong> Öffnen</span>
      </p>
    </div>
  </div>

  <!-- Detail Dialog -->
  <p-dialog 
    [(visible)]="detailDialogVisible" 
    [header]="selectedTopic?.header || 'Thema Details'"
    [modal]="true"
    [closable]="true"
    [dismissableMask]="true"
    [style]="{width: '800px', maxWidth: '95vw'}"
    (onHide)="closeDetailDialog()"
    styleClass="detail-dialog">
    
    <div class="dialog-content" *ngIf="selectedTopic">
      <!-- Master Copy Button at top -->
      <div class="dialog-actions-top">
        <p-button 
          label="Alles für E-Mail kopieren" 
          icon="pi pi-envelope" 
          severity="primary"
          (onClick)="copyAllForEmail()">
        </p-button>
      </div>

      <!-- Description -->
      <div class="detail-section" *ngIf="selectedTopic.description">
        <div class="section-header">
          <h4>Beschreibung</h4>
          <p-button 
            icon="pi pi-copy" 
            [text]="true" 
            size="small"
            (onClick)="copyField('Beschreibung', selectedTopic.description || '')">
          </p-button>
        </div>
        <p class="section-content">{{ selectedTopic.description }}</p>
      </div>

      <p-divider></p-divider>

      <!-- RACI Section -->
      <div class="detail-section">
        <h4>Verantwortliche (RACI)</h4>
        
        <div class="raci-detail-grid">
          <!-- R1 -->
          <div class="raci-detail-row">
            <div class="raci-detail-label">
              <span class="raci-badge r-badge">R1</span>
              <span class="raci-role">Hauptverantwortlich</span>
            </div>
            <div class="raci-detail-value">
              <span class="member-name">{{ getMemberName(selectedTopic.raci.r1MemberId) }}</span>
              <span class="member-email" *ngIf="getMemberEmail(selectedTopic.raci.r1MemberId)">
                {{ getMemberEmail(selectedTopic.raci.r1MemberId) }}
              </span>
            </div>
            <div class="raci-detail-actions">
              <p-button 
                icon="pi pi-copy" 
                [text]="true" 
                size="small"
                pTooltip="Name kopieren"
                (onClick)="copyField('R1', getMemberName(selectedTopic.raci.r1MemberId))">
              </p-button>
              <p-button 
                *ngIf="getMemberEmail(selectedTopic.raci.r1MemberId)"
                icon="pi pi-at" 
                [text]="true" 
                size="small"
                pTooltip="E-Mail kopieren"
                (onClick)="copyField('R1 E-Mail', getMemberEmail(selectedTopic.raci.r1MemberId))">
              </p-button>
            </div>
          </div>

          <!-- R2 -->
          <div class="raci-detail-row" *ngIf="selectedTopic.raci.r2MemberId">
            <div class="raci-detail-label">
              <span class="raci-badge r-badge">R2</span>
              <span class="raci-role">Stellvertretung</span>
            </div>
            <div class="raci-detail-value">
              <span class="member-name">{{ getMemberName(selectedTopic.raci.r2MemberId) }}</span>
              <span class="member-email" *ngIf="getMemberEmail(selectedTopic.raci.r2MemberId)">
                {{ getMemberEmail(selectedTopic.raci.r2MemberId) }}
              </span>
            </div>
            <div class="raci-detail-actions">
              <p-button 
                icon="pi pi-copy" 
                [text]="true" 
                size="small"
                (onClick)="copyField('R2', getMemberName(selectedTopic.raci.r2MemberId || ''))">
              </p-button>
              <p-button 
                *ngIf="getMemberEmail(selectedTopic.raci.r2MemberId || '')"
                icon="pi pi-at" 
                [text]="true" 
                size="small"
                (onClick)="copyField('R2 E-Mail', getMemberEmail(selectedTopic.raci.r2MemberId || ''))">
              </p-button>
            </div>
          </div>

          <!-- R3 -->
          <div class="raci-detail-row" *ngIf="selectedTopic.raci.r3MemberId">
            <div class="raci-detail-label">
              <span class="raci-badge r-badge">R3</span>
              <span class="raci-role">Weitere Stellv.</span>
            </div>
            <div class="raci-detail-value">
              <span class="member-name">{{ getMemberName(selectedTopic.raci.r3MemberId) }}</span>
              <span class="member-email" *ngIf="getMemberEmail(selectedTopic.raci.r3MemberId)">
                {{ getMemberEmail(selectedTopic.raci.r3MemberId) }}
              </span>
            </div>
            <div class="raci-detail-actions">
              <p-button 
                icon="pi pi-copy" 
                [text]="true" 
                size="small"
                (onClick)="copyField('R3', getMemberName(selectedTopic.raci.r3MemberId || ''))">
              </p-button>
              <p-button 
                *ngIf="getMemberEmail(selectedTopic.raci.r3MemberId || '')"
                icon="pi pi-at" 
                [text]="true" 
                size="small"
                (onClick)="copyField('R3 E-Mail', getMemberEmail(selectedTopic.raci.r3MemberId || ''))">
              </p-button>
            </div>
          </div>

          <!-- Informed (I) -->
          <div class="raci-detail-row" *ngIf="selectedTopic.raci.iMemberIds && selectedTopic.raci.iMemberIds.length > 0">
            <div class="raci-detail-label">
              <span class="raci-badge i-badge">I</span>
              <span class="raci-role">Informed</span>
            </div>
            <div class="raci-detail-value multi-value">
              <div class="member-item" *ngFor="let memberId of selectedTopic.raci.iMemberIds">
                <span class="member-name">{{ getMemberName(memberId) }}</span>
                <span class="member-email" *ngIf="getMemberEmail(memberId)">{{ getMemberEmail(memberId) }}</span>
                <p-button 
                  icon="pi pi-copy" 
                  [text]="true" 
                  size="small"
                  (onClick)="copyField('I', getMemberName(memberId))">
                </p-button>
              </div>
            </div>
          </div>

          <!-- Consulted (C) -->
          <div class="raci-detail-row" *ngIf="selectedTopic.raci.cMemberIds && selectedTopic.raci.cMemberIds.length > 0">
            <div class="raci-detail-label">
              <span class="raci-badge c-badge">C</span>
              <span class="raci-role">Consulted</span>
            </div>
            <div class="raci-detail-value multi-value">
              <div class="member-item" *ngFor="let memberId of selectedTopic.raci.cMemberIds">
                <span class="member-name">{{ getMemberName(memberId) }}</span>
                <span class="member-email" *ngIf="getMemberEmail(memberId)">{{ getMemberEmail(memberId) }}</span>
                <p-button 
                  icon="pi pi-copy" 
                  [text]="true" 
                  size="small"
                  (onClick)="copyField('C', getMemberName(memberId))">
                </p-button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Tags Section -->
      <div class="detail-section" *ngIf="selectedTopicTags.length > 0">
        <h4>Tags</h4>
        <div class="tags-detail-grid">
          <div class="tag-detail-item" *ngFor="let tag of selectedTopicTags">
            <div class="tag-header">
              <p-tag [value]="tag.name" severity="info"></p-tag>
              <p-button 
                *ngIf="tag.copyPasteText"
                icon="pi pi-copy" 
                [text]="true" 
                size="small"
                pTooltip="Textvorlage kopieren"
                (onClick)="copyField('Tag ' + tag.name, tag.copyPasteText)">
              </p-button>
            </div>
            <p class="tag-hinweise" *ngIf="tag.hinweise">{{ tag.hinweise }}</p>
            <div class="tag-copy-text" *ngIf="tag.copyPasteText">
              <span class="copy-text-label">Textvorlage:</span>
              <span class="copy-text-content">{{ tag.copyPasteText }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Notes Section -->
      <div class="detail-section" *ngIf="selectedTopic.notes">
        <p-divider></p-divider>
        <div class="section-header">
          <h4>Notizen</h4>
          <p-button 
            icon="pi pi-copy" 
            [text]="true" 
            size="small"
            (onClick)="copyField('Notizen', selectedTopic.notes || '')">
          </p-button>
        </div>
        <p class="section-content notes-content">{{ selectedTopic.notes }}</p>
      </div>

      <!-- Classification Section -->
      <div class="detail-section" *ngIf="selectedTopic.priority || selectedTopic.size">
        <p-divider></p-divider>
        <h4>Klassifizierung</h4>
        <div class="classification-info">
          <div class="classification-item" *ngIf="selectedTopic.priority">
            <span class="classification-label">Priorität:</span>
            <p-rating [(ngModel)]="selectedTopic.priority" [stars]="10" [readonly]="true"></p-rating>
            <span class="priority-value">({{ selectedTopic.priority }}/10)</span>
          </div>
          <div class="classification-item" *ngIf="selectedTopic.size">
            <span class="classification-label">Größe:</span>
            <p-tag [value]="selectedTopic.size" [severity]="getSizeSeverity(selectedTopic.size)"></p-tag>
          </div>
        </div>
      </div>

      <!-- References Section -->
      <div class="detail-section" *ngIf="(selectedTopic.hasFileNumber && selectedTopic.fileNumber) || (selectedTopic.hasSharedFilePath && selectedTopic.sharedFilePath)">
        <p-divider></p-divider>
        <h4>Referenzen</h4>
        <div class="references-info">
          <div class="reference-row" *ngIf="selectedTopic.hasFileNumber && selectedTopic.fileNumber">
            <span class="reference-label"><i class="pi pi-file"></i> Aktenzeichen:</span>
            <span class="reference-value">{{ selectedTopic.fileNumber }}</span>
            <p-button 
              icon="pi pi-copy" 
              [text]="true" 
              size="small"
              (onClick)="copyField('Aktenzeichen', selectedTopic.fileNumber || '')">
            </p-button>
          </div>
          <div class="reference-row" *ngIf="selectedTopic.hasSharedFilePath && selectedTopic.sharedFilePath">
            <span class="reference-label"><i class="pi pi-folder"></i> Ablageort:</span>
            <span class="reference-value">{{ selectedTopic.sharedFilePath }}</span>
            <p-button 
              icon="pi pi-copy" 
              [text]="true" 
              size="small"
              (onClick)="copyField('Ablageort', selectedTopic.sharedFilePath || '')">
            </p-button>
          </div>
        </div>
      </div>

      <!-- Validity -->
      <div class="detail-section validity-section">
        <p-divider></p-divider>
        <div class="validity-info">
          <span class="validity-label">Gültigkeit:</span>
          <p-tag [value]="getValidityBadge(selectedTopic)" [severity]="getValiditySeverity(selectedTopic)"></p-tag>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <div class="dialog-shortcuts">
          <span class="shortcut-hint"><kbd>Ctrl+Shift+C</kbd> Mail-Block kopieren</span>
          <span class="shortcut-hint"><kbd>Ctrl+Shift+E</kbd> E-Mail kopieren</span>
          <span class="shortcut-hint"><kbd>Ctrl+Shift+D</kbd> Beschreibung kopieren</span>
          <span class="shortcut-hint"><kbd>Esc</kbd> Schließen</span>
        </div>
        <p-button label="Schließen" icon="pi pi-times" [text]="true" (onClick)="closeDetailDialog()"></p-button>
      </div>
    </ng-template>
  </p-dialog>
</div>
